- name: Set up AWS creds For Pipeline
  uses: aws-actions/configure-aws-credentials@v1-node16
  with:
    role-to-assume: ${{ secrets.GH_ACTIONS_ROLE_ARN_NOTAGS }}
    aws-region: eu-west-2

- name: Get .aws-sam environment from S3
  working-directory: ./deploy
  continue-on-error: true
  env:
    S3_BUCKET: ${{ secrets.ARTIFACT_BUCKET_NAME_NOTAGS }}
    SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID_NOTAGS }}
  run: |
    aws s3 cp s3://$S3_BUCKET/envpackage.zip ./
    ls -la
    unzip ./envpackage.zip
    md5sum ./samdir.zip | cut -c -32 > zipsum.txt
    aws kms verify --key-id $SIGNING_KEY_ID --signature fileb://ZipSignature --message fileb://zipsum.txt --signing-algorithm RSASSA_PSS_SHA_256
    unzip ./samdir.zip

- name: Put current .sam-aws environment in S3
  working-directory: ./deploy
  env:
    S3_BUCKET: ${{ secrets.ARTIFACT_BUCKET_NAME_NOTAGS }}
    SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID_NOTAGS }}
  run: |
    ls -la
    zip -r ./samdir.zip ./.aws-sam
    md5sum ./samdir.zip | cut -c -32 > zipsum.txt
    aws kms sign --key-id $SIGNING_KEY_ID --message fileb://zipsum.txt --signing-algorithm RSASSA_PSS_SHA_256 --message-type RAW --output text --query Signature | base64 --decode > ZipSignature
    zip -r ./envpackage.zip ./samdir.zip ./ZipSignature ./zipsum.txt
    aws s3 cp envpackage.zip "s3://$S3_BUCKET/envpackage.zip" --metadata "repository=$GITHUB_REPOSITORY,commitsha=$GITHUB_SHA"
    echo "environment zip file uploaded"